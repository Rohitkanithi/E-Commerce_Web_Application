import { Injectable, inject } from '@angular/core';
import { BehaviorSubject, of, throwError } from 'rxjs';
import { map, retry, switchMap } from 'rxjs/operators';
import { DataService } from '../api/data.service';
import { LoggerService } from '../logging/logger.service';
import { EventTypes } from '../public-events/event-types';
import { PublicEventsService } from '../public-events/public-events.service';
import { StoragePersistenceService } from '../storage/storage-persistence.service';
import { FlowHelper } from '../utils/flowHelper/flow-helper.service';
import { TokenHelperService } from '../utils/tokenHelper/token-helper.service';
import * as i0 from "@angular/core";
const DEFAULT_USERRESULT = { userData: null, allUserData: [] };
export class UserService {
    constructor() {
        this.userDataInternal$ = new BehaviorSubject(DEFAULT_USERRESULT);
        this.loggerService = inject(LoggerService);
        this.tokenHelperService = inject(TokenHelperService);
        this.flowHelper = inject(FlowHelper);
        this.oidcDataService = inject(DataService);
        this.storagePersistenceService = inject(StoragePersistenceService);
        this.eventService = inject(PublicEventsService);
    }
    get userData$() {
        return this.userDataInternal$.asObservable();
    }
    getAndPersistUserDataInStore(currentConfiguration, allConfigs, isRenewProcess = false, idToken, decodedIdToken) {
        idToken =
            idToken ||
                this.storagePersistenceService.getIdToken(currentConfiguration);
        decodedIdToken =
            decodedIdToken ||
                this.tokenHelperService.getPayloadFromToken(idToken, false, currentConfiguration);
        const existingUserDataFromStorage = this.getUserDataFromStore(currentConfiguration);
        const haveUserData = !!existingUserDataFromStorage;
        const isCurrentFlowImplicitFlowWithAccessToken = this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(currentConfiguration);
        const isCurrentFlowCodeFlow = this.flowHelper.isCurrentFlowCodeFlow(currentConfiguration);
        const accessToken = this.storagePersistenceService.getAccessToken(currentConfiguration);
        if (!(isCurrentFlowImplicitFlowWithAccessToken || isCurrentFlowCodeFlow)) {
            this.loggerService.logDebug(currentConfiguration, `authCallback idToken flow with accessToken ${accessToken}`);
            this.setUserDataToStore(decodedIdToken, currentConfiguration, allConfigs);
            return of(decodedIdToken);
        }
        const { renewUserInfoAfterTokenRenew } = currentConfiguration;
        if (!isRenewProcess || renewUserInfoAfterTokenRenew || !haveUserData) {
            return this.getUserDataOidcFlowAndSave(decodedIdToken.sub, currentConfiguration, allConfigs).pipe(switchMap((userData) => {
                this.loggerService.logDebug(currentConfiguration, 'Received user data: ', userData);
                if (!!userData) {
                    this.loggerService.logDebug(currentConfiguration, 'accessToken: ', accessToken);
                    return of(userData);
                }
                else {
                    return throwError(() => new Error('Received no user data, request failed'));
                }
            }));
        }
        return of(existingUserDataFromStorage);
    }
    getUserDataFromStore(currentConfiguration) {
        if (!currentConfiguration) {
            return throwError(() => new Error('Please provide a configuration before setting up the module'));
        }
        return (this.storagePersistenceService.read('userData', currentConfiguration) ||
            null);
    }
    publishUserDataIfExists(currentConfiguration, allConfigs) {
        const userData = this.getUserDataFromStore(currentConfiguration);
        if (userData) {
            this.fireUserDataEvent(currentConfiguration, allConfigs, userData);
        }
    }
    setUserDataToStore(userData, currentConfiguration, allConfigs) {
        this.storagePersistenceService.write('userData', userData, currentConfiguration);
        this.fireUserDataEvent(currentConfiguration, allConfigs, userData);
    }
    resetUserDataInStore(currentConfiguration, allConfigs) {
        this.storagePersistenceService.remove('userData', currentConfiguration);
        this.fireUserDataEvent(currentConfiguration, allConfigs, null);
    }
    getUserDataOidcFlowAndSave(idTokenSub, currentConfiguration, allConfigs) {
        return this.getIdentityUserData(currentConfiguration).pipe(map((data) => {
            if (this.validateUserDataSubIdToken(currentConfiguration, idTokenSub, data?.sub)) {
                this.setUserDataToStore(data, currentConfiguration, allConfigs);
                return data;
            }
            else {
                // something went wrong, user data sub does not match that from id_token
                this.loggerService.logWarning(currentConfiguration, `User data sub does not match sub in id_token, resetting`);
                this.resetUserDataInStore(currentConfiguration, allConfigs);
                return null;
            }
        }));
    }
    getIdentityUserData(currentConfiguration) {
        const token = this.storagePersistenceService.getAccessToken(currentConfiguration);
        const authWellKnownEndPoints = this.storagePersistenceService.read('authWellKnownEndPoints', currentConfiguration);
        if (!authWellKnownEndPoints) {
            this.loggerService.logWarning(currentConfiguration, 'init check session: authWellKnownEndpoints is undefined');
            return throwError(() => new Error('authWellKnownEndpoints is undefined'));
        }
        const userInfoEndpoint = authWellKnownEndPoints.userInfoEndpoint;
        if (!userInfoEndpoint) {
            this.loggerService.logError(currentConfiguration, 'init check session: authWellKnownEndpoints.userinfo_endpoint is undefined; set auto_userinfo = false in config');
            return throwError(() => new Error('authWellKnownEndpoints.userinfo_endpoint is undefined'));
        }
        return this.oidcDataService
            .get(userInfoEndpoint, currentConfiguration, token)
            .pipe(retry(2));
    }
    validateUserDataSubIdToken(currentConfiguration, idTokenSub, userDataSub) {
        if (!idTokenSub) {
            return false;
        }
        if (!userDataSub) {
            return false;
        }
        if (idTokenSub.toString() !== userDataSub.toString()) {
            this.loggerService.logDebug(currentConfiguration, 'validateUserDataSubIdToken failed', idTokenSub, userDataSub);
            return false;
        }
        return true;
    }
    fireUserDataEvent(currentConfiguration, allConfigs, passedUserData) {
        const userData = this.composeSingleOrMultipleUserDataObject(currentConfiguration, allConfigs, passedUserData);
        this.userDataInternal$.next(userData);
        const { configId } = currentConfiguration;
        this.eventService.fireEvent(EventTypes.UserDataChanged, {
            configId,
            userData: passedUserData,
        });
    }
    composeSingleOrMultipleUserDataObject(currentConfiguration, allConfigs, passedUserData) {
        const hasManyConfigs = allConfigs.length > 1;
        if (!hasManyConfigs) {
            const { configId } = currentConfiguration;
            return this.composeSingleUserDataResult(configId ?? '', passedUserData);
        }
        const allUserData = allConfigs.map((config) => {
            const currentConfigId = currentConfiguration.configId ?? '';
            const configId = config.configId ?? '';
            if (this.currentConfigIsToUpdate(currentConfigId, config)) {
                return { configId, userData: passedUserData };
            }
            const alreadySavedUserData = this.storagePersistenceService.read('userData', config) || null;
            return {
                configId,
                userData: alreadySavedUserData,
            };
        });
        return {
            userData: null,
            allUserData,
        };
    }
    composeSingleUserDataResult(configId, userData) {
        return {
            userData,
            allUserData: [{ configId, userData }],
        };
    }
    currentConfigIsToUpdate(configId, config) {
        return config.configId === configId;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: UserService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: UserService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: UserService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYW5ndWxhci1hdXRoLW9pZGMtY2xpZW50L3NyYy9saWIvdXNlci1kYXRhL3VzZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsZUFBZSxFQUFjLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbkUsT0FBTyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWxELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDMUQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDN0UsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDbkYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDJDQUEyQyxDQUFDOztBQUcvRSxNQUFNLGtCQUFrQixHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUM7QUFHL0QsTUFBTSxPQUFPLFdBQVc7SUFEeEI7UUFFbUIsc0JBQWlCLEdBQUcsSUFBSSxlQUFlLENBQ3RELGtCQUFrQixDQUNuQixDQUFDO1FBTWUsa0JBQWEsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFdEMsdUJBQWtCLEdBQUcsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFFaEQs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LFdBQVc7a0JBRHZCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHJldHJ5LCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBEYXRhU2VydmljZSB9IGZyb20gJy4uL2FwaS9kYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgT3BlbklkQ29uZmlndXJhdGlvbiB9IGZyb20gJy4uL2NvbmZpZy9vcGVuaWQtY29uZmlndXJhdGlvbic7XG5pbXBvcnQgeyBMb2dnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vbG9nZ2luZy9sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBFdmVudFR5cGVzIH0gZnJvbSAnLi4vcHVibGljLWV2ZW50cy9ldmVudC10eXBlcyc7XG5pbXBvcnQgeyBQdWJsaWNFdmVudHNTZXJ2aWNlIH0gZnJvbSAnLi4vcHVibGljLWV2ZW50cy9wdWJsaWMtZXZlbnRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZSB9IGZyb20gJy4uL3N0b3JhZ2Uvc3RvcmFnZS1wZXJzaXN0ZW5jZS5zZXJ2aWNlJztcbmltcG9ydCB7IEZsb3dIZWxwZXIgfSBmcm9tICcuLi91dGlscy9mbG93SGVscGVyL2Zsb3ctaGVscGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgVG9rZW5IZWxwZXJTZXJ2aWNlIH0gZnJvbSAnLi4vdXRpbHMvdG9rZW5IZWxwZXIvdG9rZW4taGVscGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29uZmlnVXNlckRhdGFSZXN1bHQsIFVzZXJEYXRhUmVzdWx0IH0gZnJvbSAnLi91c2VyZGF0YS1yZXN1bHQnO1xuXG5jb25zdCBERUZBVUxUX1VTRVJSRVNVTFQgPSB7IHVzZXJEYXRhOiBudWxsLCBhbGxVc2VyRGF0YTogW10gfTtcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBVc2VyU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgdXNlckRhdGFJbnRlcm5hbCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFVzZXJEYXRhUmVzdWx0PihcbiAgICBERUZBVUxUX1VTRVJSRVNVTFRcbiAgKTtcblxuICBnZXQgdXNlckRhdGEkKCk6IE9ic2VydmFibGU8VXNlckRhdGFSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy51c2VyRGF0YUludGVybmFsJC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyU2VydmljZSA9IGluamVjdChMb2dnZXJTZXJ2aWNlKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IHRva2VuSGVscGVyU2VydmljZSA9IGluamVjdChUb2tlbkhlbHBlclNlcnZpY2UpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZmxvd0hlbHBlciA9IGluamVjdChGbG93SGVscGVyKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IG9pZGNEYXRhU2VydmljZSA9IGluamVjdChEYXRhU2VydmljZSk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBzdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlID0gaW5qZWN0KFxuICAgIFN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2VcbiAgKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50U2VydmljZSA9IGluamVjdChQdWJsaWNFdmVudHNTZXJ2aWNlKTtcblxuICBnZXRBbmRQZXJzaXN0VXNlckRhdGFJblN0b3JlKFxuICAgIGN1cnJlbnRDb25maWd1cmF0aW9uOiBPcGVuSWRDb25maWd1cmF0aW9uLFxuICAgIGFsbENvbmZpZ3M6IE9wZW5JZENvbmZpZ3VyYXRpb25bXSxcbiAgICBpc1JlbmV3UHJvY2VzcyA9IGZhbHNlLFxuICAgIGlkVG9rZW4/OiBzdHJpbmcsXG4gICAgZGVjb2RlZElkVG9rZW4/OiBhbnlcbiAgKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZFRva2VuID1cbiAgICAgIGlkVG9rZW4gfHxcbiAgICAgIHRoaXMuc3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZS5nZXRJZFRva2VuKGN1cnJlbnRDb25maWd1cmF0aW9uKTtcbiAgICBkZWNvZGVkSWRUb2tlbiA9XG4gICAgICBkZWNvZGVkSWRUb2tlbiB8fFxuICAgICAgdGhpcy50b2tlbkhlbHBlclNlcnZpY2UuZ2V0UGF5bG9hZEZyb21Ub2tlbihcbiAgICAgICAgaWRUb2tlbixcbiAgICAgICAgZmFsc2UsXG4gICAgICAgIGN1cnJlbnRDb25maWd1cmF0aW9uXG4gICAgICApO1xuXG4gICAgY29uc3QgZXhpc3RpbmdVc2VyRGF0YUZyb21TdG9yYWdlID1cbiAgICAgIHRoaXMuZ2V0VXNlckRhdGFGcm9tU3RvcmUoY3VycmVudENvbmZpZ3VyYXRpb24pO1xuICAgIGNvbnN0IGhhdmVVc2VyRGF0YSA9ICEhZXhpc3RpbmdVc2VyRGF0YUZyb21TdG9yYWdlO1xuICAgIGNvbnN0IGlzQ3VycmVudEZsb3dJbXBsaWNpdEZsb3dXaXRoQWNjZXNzVG9rZW4gPVxuICAgICAgdGhpcy5mbG93SGVscGVyLmlzQ3VycmVudEZsb3dJbXBsaWNpdEZsb3dXaXRoQWNjZXNzVG9rZW4oXG4gICAgICAgIGN1cnJlbnRDb25maWd1cmF0aW9uXG4gICAgICApO1xuICAgIGNvbnN0IGlzQ3VycmVudEZsb3dDb2RlRmxvdyA9XG4gICAgICB0aGlzLmZsb3dIZWxwZXIuaXNDdXJyZW50Rmxvd0NvZGVGbG93KGN1cnJlbnRDb25maWd1cmF0aW9uKTtcblxuICAgIGNvbnN0IGFjY2Vzc1Rva2VuID1cbiAgICAgIHRoaXMuc3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZS5nZXRBY2Nlc3NUb2tlbihjdXJyZW50Q29uZmlndXJhdGlvbik7XG5cbiAgICBpZiAoIShpc0N1cnJlbnRGbG93SW1wbGljaXRGbG93V2l0aEFjY2Vzc1Rva2VuIHx8IGlzQ3VycmVudEZsb3dDb2RlRmxvdykpIHtcbiAgICAgIHRoaXMubG9nZ2VyU2VydmljZS5sb2dEZWJ1ZyhcbiAgICAgICAgY3VycmVudENvbmZpZ3VyYXRpb24sXG4gICAgICAgIGBhdXRoQ2FsbGJhY2sgaWRUb2tlbiBmbG93IHdpdGggYWNjZXNzVG9rZW4gJHthY2Nlc3NUb2tlbn1gXG4gICAgICApO1xuXG4gICAgICB0aGlzLnNldFVzZXJEYXRhVG9TdG9yZShkZWNvZGVkSWRUb2tlbiwgY3VycmVudENvbmZpZ3VyYXRpb24sIGFsbENvbmZpZ3MpO1xuXG4gICAgICByZXR1cm4gb2YoZGVjb2RlZElkVG9rZW4pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgcmVuZXdVc2VySW5mb0FmdGVyVG9rZW5SZW5ldyB9ID0gY3VycmVudENvbmZpZ3VyYXRpb247XG5cbiAgICBpZiAoIWlzUmVuZXdQcm9jZXNzIHx8IHJlbmV3VXNlckluZm9BZnRlclRva2VuUmVuZXcgfHwgIWhhdmVVc2VyRGF0YSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0VXNlckRhdGFPaWRjRmxvd0FuZFNhdmUoXG4gICAgICAgIGRlY29kZWRJZFRva2VuLnN1YixcbiAgICAgICAgY3VycmVudENvbmZpZ3VyYXRpb24sXG4gICAgICAgIGFsbENvbmZpZ3NcbiAgICAgICkucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKCh1c2VyRGF0YSkgPT4ge1xuICAgICAgICAgIHRoaXMubG9nZ2VyU2VydmljZS5sb2dEZWJ1ZyhcbiAgICAgICAgICAgIGN1cnJlbnRDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgJ1JlY2VpdmVkIHVzZXIgZGF0YTogJyxcbiAgICAgICAgICAgIHVzZXJEYXRhXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAoISF1c2VyRGF0YSkge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKFxuICAgICAgICAgICAgICBjdXJyZW50Q29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgJ2FjY2Vzc1Rva2VuOiAnLFxuICAgICAgICAgICAgICBhY2Nlc3NUb2tlblxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgcmV0dXJuIG9mKHVzZXJEYXRhKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoXG4gICAgICAgICAgICAgICgpID0+IG5ldyBFcnJvcignUmVjZWl2ZWQgbm8gdXNlciBkYXRhLCByZXF1ZXN0IGZhaWxlZCcpXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9mKGV4aXN0aW5nVXNlckRhdGFGcm9tU3RvcmFnZSk7XG4gIH1cblxuICBnZXRVc2VyRGF0YUZyb21TdG9yZShjdXJyZW50Q29uZmlndXJhdGlvbjogT3BlbklkQ29uZmlndXJhdGlvbiB8IG51bGwpOiBhbnkge1xuICAgIGlmICghY3VycmVudENvbmZpZ3VyYXRpb24pIHtcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKFxuICAgICAgICAoKSA9PlxuICAgICAgICAgIG5ldyBFcnJvcihcbiAgICAgICAgICAgICdQbGVhc2UgcHJvdmlkZSBhIGNvbmZpZ3VyYXRpb24gYmVmb3JlIHNldHRpbmcgdXAgdGhlIG1vZHVsZSdcbiAgICAgICAgICApXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2UucmVhZCgndXNlckRhdGEnLCBjdXJyZW50Q29uZmlndXJhdGlvbikgfHxcbiAgICAgIG51bGxcbiAgICApO1xuICB9XG5cbiAgcHVibGlzaFVzZXJEYXRhSWZFeGlzdHMoXG4gICAgY3VycmVudENvbmZpZ3VyYXRpb246IE9wZW5JZENvbmZpZ3VyYXRpb24sXG4gICAgYWxsQ29uZmlnczogT3BlbklkQ29uZmlndXJhdGlvbltdXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IHVzZXJEYXRhID0gdGhpcy5nZXRVc2VyRGF0YUZyb21TdG9yZShjdXJyZW50Q29uZmlndXJhdGlvbik7XG5cbiAgICBpZiAodXNlckRhdGEpIHtcbiAgICAgIHRoaXMuZmlyZVVzZXJEYXRhRXZlbnQoY3VycmVudENvbmZpZ3VyYXRpb24sIGFsbENvbmZpZ3MsIHVzZXJEYXRhKTtcbiAgICB9XG4gIH1cblxuICBzZXRVc2VyRGF0YVRvU3RvcmUoXG4gICAgdXNlckRhdGE6IGFueSxcbiAgICBjdXJyZW50Q29uZmlndXJhdGlvbjogT3BlbklkQ29uZmlndXJhdGlvbixcbiAgICBhbGxDb25maWdzOiBPcGVuSWRDb25maWd1cmF0aW9uW11cbiAgKTogdm9pZCB7XG4gICAgdGhpcy5zdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlLndyaXRlKFxuICAgICAgJ3VzZXJEYXRhJyxcbiAgICAgIHVzZXJEYXRhLFxuICAgICAgY3VycmVudENvbmZpZ3VyYXRpb25cbiAgICApO1xuICAgIHRoaXMuZmlyZVVzZXJEYXRhRXZlbnQoY3VycmVudENvbmZpZ3VyYXRpb24sIGFsbENvbmZpZ3MsIHVzZXJEYXRhKTtcbiAgfVxuXG4gIHJlc2V0VXNlckRhdGFJblN0b3JlKFxuICAgIGN1cnJlbnRDb25maWd1cmF0aW9uOiBPcGVuSWRDb25maWd1cmF0aW9uLFxuICAgIGFsbENvbmZpZ3M6IE9wZW5JZENvbmZpZ3VyYXRpb25bXVxuICApOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2UucmVtb3ZlKCd1c2VyRGF0YScsIGN1cnJlbnRDb25maWd1cmF0aW9uKTtcbiAgICB0aGlzLmZpcmVVc2VyRGF0YUV2ZW50KGN1cnJlbnRDb25maWd1cmF0aW9uLCBhbGxDb25maWdzLCBudWxsKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VXNlckRhdGFPaWRjRmxvd0FuZFNhdmUoXG4gICAgaWRUb2tlblN1YjogYW55LFxuICAgIGN1cnJlbnRDb25maWd1cmF0aW9uOiBPcGVuSWRDb25maWd1cmF0aW9uLFxuICAgIGFsbENvbmZpZ3M6IE9wZW5JZENvbmZpZ3VyYXRpb25bXVxuICApOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmdldElkZW50aXR5VXNlckRhdGEoY3VycmVudENvbmZpZ3VyYXRpb24pLnBpcGUoXG4gICAgICBtYXAoKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgdGhpcy52YWxpZGF0ZVVzZXJEYXRhU3ViSWRUb2tlbihcbiAgICAgICAgICAgIGN1cnJlbnRDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgaWRUb2tlblN1YixcbiAgICAgICAgICAgIGRhdGE/LnN1YlxuICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpcy5zZXRVc2VyRGF0YVRvU3RvcmUoZGF0YSwgY3VycmVudENvbmZpZ3VyYXRpb24sIGFsbENvbmZpZ3MpO1xuXG4gICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gc29tZXRoaW5nIHdlbnQgd3JvbmcsIHVzZXIgZGF0YSBzdWIgZG9lcyBub3QgbWF0Y2ggdGhhdCBmcm9tIGlkX3Rva2VuXG4gICAgICAgICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ1dhcm5pbmcoXG4gICAgICAgICAgICBjdXJyZW50Q29uZmlndXJhdGlvbixcbiAgICAgICAgICAgIGBVc2VyIGRhdGEgc3ViIGRvZXMgbm90IG1hdGNoIHN1YiBpbiBpZF90b2tlbiwgcmVzZXR0aW5nYFxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5yZXNldFVzZXJEYXRhSW5TdG9yZShjdXJyZW50Q29uZmlndXJhdGlvbiwgYWxsQ29uZmlncyk7XG5cbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRJZGVudGl0eVVzZXJEYXRhKFxuICAgIGN1cnJlbnRDb25maWd1cmF0aW9uOiBPcGVuSWRDb25maWd1cmF0aW9uXG4gICk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgdG9rZW4gPVxuICAgICAgdGhpcy5zdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlLmdldEFjY2Vzc1Rva2VuKGN1cnJlbnRDb25maWd1cmF0aW9uKTtcblxuICAgIGNvbnN0IGF1dGhXZWxsS25vd25FbmRQb2ludHMgPSB0aGlzLnN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2UucmVhZChcbiAgICAgICdhdXRoV2VsbEtub3duRW5kUG9pbnRzJyxcbiAgICAgIGN1cnJlbnRDb25maWd1cmF0aW9uXG4gICAgKTtcblxuICAgIGlmICghYXV0aFdlbGxLbm93bkVuZFBvaW50cykge1xuICAgICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ1dhcm5pbmcoXG4gICAgICAgIGN1cnJlbnRDb25maWd1cmF0aW9uLFxuICAgICAgICAnaW5pdCBjaGVjayBzZXNzaW9uOiBhdXRoV2VsbEtub3duRW5kcG9pbnRzIGlzIHVuZGVmaW5lZCdcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKCgpID0+IG5ldyBFcnJvcignYXV0aFdlbGxLbm93bkVuZHBvaW50cyBpcyB1bmRlZmluZWQnKSk7XG4gICAgfVxuXG4gICAgY29uc3QgdXNlckluZm9FbmRwb2ludCA9IGF1dGhXZWxsS25vd25FbmRQb2ludHMudXNlckluZm9FbmRwb2ludDtcblxuICAgIGlmICghdXNlckluZm9FbmRwb2ludCkge1xuICAgICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ0Vycm9yKFxuICAgICAgICBjdXJyZW50Q29uZmlndXJhdGlvbixcbiAgICAgICAgJ2luaXQgY2hlY2sgc2Vzc2lvbjogYXV0aFdlbGxLbm93bkVuZHBvaW50cy51c2VyaW5mb19lbmRwb2ludCBpcyB1bmRlZmluZWQ7IHNldCBhdXRvX3VzZXJpbmZvID0gZmFsc2UgaW4gY29uZmlnJ1xuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHRocm93RXJyb3IoXG4gICAgICAgICgpID0+IG5ldyBFcnJvcignYXV0aFdlbGxLbm93bkVuZHBvaW50cy51c2VyaW5mb19lbmRwb2ludCBpcyB1bmRlZmluZWQnKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5vaWRjRGF0YVNlcnZpY2VcbiAgICAgIC5nZXQodXNlckluZm9FbmRwb2ludCwgY3VycmVudENvbmZpZ3VyYXRpb24sIHRva2VuKVxuICAgICAgLnBpcGUocmV0cnkoMikpO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVVzZXJEYXRhU3ViSWRUb2tlbihcbiAgICBjdXJyZW50Q29uZmlndXJhdGlvbjogT3BlbklkQ29uZmlndXJhdGlvbixcbiAgICBpZFRva2VuU3ViOiBhbnksXG4gICAgdXNlckRhdGFTdWI6IGFueVxuICApOiBib29sZWFuIHtcbiAgICBpZiAoIWlkVG9rZW5TdWIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoIXVzZXJEYXRhU3ViKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKGlkVG9rZW5TdWIudG9TdHJpbmcoKSAhPT0gdXNlckRhdGFTdWIudG9TdHJpbmcoKSkge1xuICAgICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKFxuICAgICAgICBjdXJyZW50Q29uZmlndXJhdGlvbixcbiAgICAgICAgJ3ZhbGlkYXRlVXNlckRhdGFTdWJJZFRva2VuIGZhaWxlZCcsXG4gICAgICAgIGlkVG9rZW5TdWIsXG4gICAgICAgIHVzZXJEYXRhU3ViXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGZpcmVVc2VyRGF0YUV2ZW50KFxuICAgIGN1cnJlbnRDb25maWd1cmF0aW9uOiBPcGVuSWRDb25maWd1cmF0aW9uLFxuICAgIGFsbENvbmZpZ3M6IE9wZW5JZENvbmZpZ3VyYXRpb25bXSxcbiAgICBwYXNzZWRVc2VyRGF0YTogYW55XG4gICk6IHZvaWQge1xuICAgIGNvbnN0IHVzZXJEYXRhID0gdGhpcy5jb21wb3NlU2luZ2xlT3JNdWx0aXBsZVVzZXJEYXRhT2JqZWN0KFxuICAgICAgY3VycmVudENvbmZpZ3VyYXRpb24sXG4gICAgICBhbGxDb25maWdzLFxuICAgICAgcGFzc2VkVXNlckRhdGFcbiAgICApO1xuXG4gICAgdGhpcy51c2VyRGF0YUludGVybmFsJC5uZXh0KHVzZXJEYXRhKTtcblxuICAgIGNvbnN0IHsgY29uZmlnSWQgfSA9IGN1cnJlbnRDb25maWd1cmF0aW9uO1xuXG4gICAgdGhpcy5ldmVudFNlcnZpY2UuZmlyZUV2ZW50KEV2ZW50VHlwZXMuVXNlckRhdGFDaGFuZ2VkLCB7XG4gICAgICBjb25maWdJZCxcbiAgICAgIHVzZXJEYXRhOiBwYXNzZWRVc2VyRGF0YSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY29tcG9zZVNpbmdsZU9yTXVsdGlwbGVVc2VyRGF0YU9iamVjdChcbiAgICBjdXJyZW50Q29uZmlndXJhdGlvbjogT3BlbklkQ29uZmlndXJhdGlvbixcbiAgICBhbGxDb25maWdzOiBPcGVuSWRDb25maWd1cmF0aW9uW10sXG4gICAgcGFzc2VkVXNlckRhdGE6IGFueVxuICApOiBVc2VyRGF0YVJlc3VsdCB7XG4gICAgY29uc3QgaGFzTWFueUNvbmZpZ3MgPSBhbGxDb25maWdzLmxlbmd0aCA+IDE7XG5cbiAgICBpZiAoIWhhc01hbnlDb25maWdzKSB7XG4gICAgICBjb25zdCB7IGNvbmZpZ0lkIH0gPSBjdXJyZW50Q29uZmlndXJhdGlvbjtcblxuICAgICAgcmV0dXJuIHRoaXMuY29tcG9zZVNpbmdsZVVzZXJEYXRhUmVzdWx0KGNvbmZpZ0lkID8/ICcnLCBwYXNzZWRVc2VyRGF0YSk7XG4gICAgfVxuXG4gICAgY29uc3QgYWxsVXNlckRhdGE6IENvbmZpZ1VzZXJEYXRhUmVzdWx0W10gPSBhbGxDb25maWdzLm1hcCgoY29uZmlnKSA9PiB7XG4gICAgICBjb25zdCBjdXJyZW50Q29uZmlnSWQgPSBjdXJyZW50Q29uZmlndXJhdGlvbi5jb25maWdJZCA/PyAnJztcbiAgICAgIGNvbnN0IGNvbmZpZ0lkID0gY29uZmlnLmNvbmZpZ0lkID8/ICcnO1xuXG4gICAgICBpZiAodGhpcy5jdXJyZW50Q29uZmlnSXNUb1VwZGF0ZShjdXJyZW50Q29uZmlnSWQsIGNvbmZpZykpIHtcbiAgICAgICAgcmV0dXJuIHsgY29uZmlnSWQsIHVzZXJEYXRhOiBwYXNzZWRVc2VyRGF0YSB9O1xuICAgICAgfVxuXG4gICAgICBjb25zdCBhbHJlYWR5U2F2ZWRVc2VyRGF0YSA9XG4gICAgICAgIHRoaXMuc3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZS5yZWFkKCd1c2VyRGF0YScsIGNvbmZpZykgfHwgbnVsbDtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgY29uZmlnSWQsXG4gICAgICAgIHVzZXJEYXRhOiBhbHJlYWR5U2F2ZWRVc2VyRGF0YSxcbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdXNlckRhdGE6IG51bGwsXG4gICAgICBhbGxVc2VyRGF0YSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjb21wb3NlU2luZ2xlVXNlckRhdGFSZXN1bHQoXG4gICAgY29uZmlnSWQ6IHN0cmluZyxcbiAgICB1c2VyRGF0YTogYW55XG4gICk6IFVzZXJEYXRhUmVzdWx0IHtcbiAgICByZXR1cm4ge1xuICAgICAgdXNlckRhdGEsXG4gICAgICBhbGxVc2VyRGF0YTogW3sgY29uZmlnSWQsIHVzZXJEYXRhIH1dLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGN1cnJlbnRDb25maWdJc1RvVXBkYXRlKFxuICAgIGNvbmZpZ0lkOiBzdHJpbmcsXG4gICAgY29uZmlnOiBPcGVuSWRDb25maWd1cmF0aW9uXG4gICk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBjb25maWcuY29uZmlnSWQgPT09IGNvbmZpZ0lkO1xuICB9XG59XG4iXX0=